{% extends 'base.html' %}

{% block title %}Gerenciamento Docker{% endblock %}

{% block content %}
<h1 class="mb-4">Containers Docker</h1>

{% if not docker_available %}
<div class="alert alert-danger">
    <h5><i class="bi bi-exclamation-triangle"></i> Erro ao acessar Docker</h5>
    <p><strong>Erro:</strong> {{ error|default:"Docker não está disponível" }}</p>
    {% if "permissão" in error|lower or "permission" in error|lower %}
    <hr>
    <p><strong>Solução:</strong></p>
    <ol>
        <li>Adicione o usuário ao grupo docker:
            <code>sudo usermod -aG docker $USER</code>
        </li>
        <li>Faça logout e login novamente, ou execute:
            <code>newgrp docker</code>
        </li>
        <li>Reinicie o servidor Django</li>
    </ol>
    <p class="mb-0"><small class="text-muted">
        <i class="bi bi-info-circle"></i> Após adicionar ao grupo, pode ser necessário reiniciar o serviço do painel.
    </small></p>
    {% endif %}
</div>
{% endif %}

<div class="card">
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Imagem</th>
                    <th>Status</th>
                    <th>CPU %</th>
                    <th>Memória</th>
                    <th>Uptime</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for container in containers %}
                <tr>
                    <td>
                        <a href="{% url 'container_detail' container.id %}">{{ container.name }}</a>
                    </td>
                    <td>{{ container.image }}</td>
                    <td>
                        <span class="badge bg-{% if container.status == 'running' %}success{% else %}secondary{% endif %}">
                            {{ container.status }}
                        </span>
                        {% if container.health %}
                            <span class="badge bg-{% if container.health == 'healthy' %}success{% else %}warning{% endif %}">
                                {{ container.health }}
                            </span>
                        {% endif %}
                    </td>
                    <td>{{ container.cpu_percent|default:"-" }}</td>
                    <td>
                        {% if container.memory_usage %}
                            {{ container.memory_usage|floatformat:2 }} MB / {{ container.memory_limit|floatformat:2 }} MB
                            ({{ container.memory_percent|default:0|floatformat:1 }}%)
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ container.uptime }}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            {% if container.status == 'running' %}
                                <button class="btn btn-warning" onclick="containerAction('{{ container.id }}', 'stop')">Stop</button>
                                <button class="btn btn-secondary" onclick="containerAction('{{ container.id }}', 'restart')">Restart</button>
                            {% else %}
                                <button class="btn btn-success" onclick="containerAction('{{ container.id }}', 'start')">Start</button>
                            {% endif %}
                            <a href="{% url 'container_detail' container.id %}" class="btn btn-info">Detalhes</a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">Nenhum container encontrado</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3">
    <a href="{% url 'docker_images' %}" class="btn btn-primary">Ver Imagens</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
let confirmCallback = null;

function ensureConfirmModal() {
    if (document.getElementById('confirm-modal')) return;
    const modal = document.createElement('div');
    modal.id = 'confirm-modal';
    modal.style.cssText = 'position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:9999;';
    modal.innerHTML = `
      <div style="background:#fff;border-radius:12px;max-width:420px;width:90%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)">
        <h5 style="margin:0 0 8px 0">Confirmar ação</h5>
        <p id="confirm-message" style="margin:0 0 16px 0;color:#555"></p>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="confirm-cancel" class="btn btn-secondary btn-sm">Cancelar</button>
          <button id="confirm-ok" class="btn btn-primary btn-sm">Confirmar</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
    document.getElementById('confirm-cancel').onclick = () => closeConfirm(false);
    document.getElementById('confirm-ok').onclick = () => closeConfirm(true);
  }

function showConfirm(message, onConfirm) {
    ensureConfirmModal();
    confirmCallback = onConfirm;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-modal').style.display = 'flex';
}

function closeConfirm(confirmed) {
    document.getElementById('confirm-modal').style.display = 'none';
    if (confirmed && typeof confirmCallback === 'function') {
        confirmCallback();
    }
    confirmCallback = null;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#1f2937;color:#fff;padding:10px 14px;border-radius:8px;font-size:13px;z-index:9999;opacity:0;transition:opacity .2s';
    document.body.appendChild(toast);
    requestAnimationFrame(() => toast.style.opacity = '1');
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 200); }, 5000);
}

function containerAction(containerId, action) {
    showConfirm(`Tem certeza que deseja ${action} este container?`, () => {
        fetch(`/docker/container/${containerId}/action/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'action=' + action
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showToast('Erro: ' + data.error, 'error');
            }
        });
    });
}
</script>
{% endblock %}

