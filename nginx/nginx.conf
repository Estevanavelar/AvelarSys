# ========================================
# NGINX - Proxy Reverso para AvelarSys
# ========================================

# Configura√ß√£o otimizada para produ√ß√£o
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# Configura√ß√µes de performance
events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    # Docker DNS resolver
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;
    
    # Configura√ß√µes b√°sicas
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logs
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
    
#     # Upstream servers (Docker containers) - Usando nomes de servi√ßos
#     upstream app_portal {
#         server app-portal:3000 max_fails=0;
#         keepalive 32;
#     }
# 
#     upstream avadmin_backend {
#         server avadmin-backend:8000 max_fails=0;
#         keepalive 32;
#     }
# 
#     upstream avadmin_frontend {
#         server avadmin-frontend:3000 max_fails=0;
#         keepalive 32;
#     }
# 
#     upstream stocktech_backend {
#         server stocktech-backend:3000 max_fails=0;
#         keepalive 32;
#     }
# 
#     upstream stocktech_frontend {
#         server stocktech-frontend:3000 max_fails=0;
#         keepalive 32;
#     }
# 
#     upstream wppconnect {
#         server wppconnect:8003 max_fails=0;
#         keepalive 32;
#     }

#     # ========================================
#     # ADMIN.AVELARCOMPANY.COM.BR - AvAdmin
#     # ========================================
#     server {
#         listen 80;
#         listen 443 ssl;
#         http2 on;
#         server_name admin.avelarcompany.com.br;
#         
#         # Let's Encrypt SSL
#         ssl_certificate /etc/letsencrypt/live/app.avelarcompany.com.br/fullchain.pem;
#         ssl_certificate_key /etc/letsencrypt/live/app.avelarcompany.com.br/privkey.pem;
#         
#         # Security headers
#         add_header X-Frame-Options "SAMEORIGIN" always;
#         add_header X-XSS-Protection "1; mode=block" always;
#         add_header X-Content-Type-Options "nosniff" always;
#         add_header Referrer-Policy "no-referrer-when-downgrade" always;
#         add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
#         
#         # API routes (backend)
#         location /api/ {
#             limit_req zone=api burst=20 nodelay;
#             
#             proxy_pass http://avadmin_backend;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#             
#             # Timeouts
#             proxy_connect_timeout 60s;
#             proxy_send_timeout 60s;
#             proxy_read_timeout 60s;
#         }
#         
#         # Authentication routes (special rate limiting)
#         location /api/auth/ {
#             limit_req zone=auth burst=10 nodelay;
#             
#             proxy_pass http://avadmin_backend;
#             proxy_http_version 1.1;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#         }
#         
#         # Frontend routes (Next.js)
#         location / {
#             proxy_pass http://avadmin_frontend;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#             
#             # Next.js specific
#             proxy_redirect off;
#             proxy_buffering off;
#         }
#         
#         # Static assets caching
#         location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
#             expires 1y;
#             add_header Cache-Control "public, immutable";
#             access_log off;
#             
#             proxy_pass http://avadmin_frontend;
#         }
#     }
# 
#     # ========================================
#     # APP.AVELARCOMPANY.COM.BR - Sistema Principal (Modules)
#     # ========================================
#     server {
#         listen 80;
#         listen 443 ssl;
#         http2 on;
#         server_name app.avelarcompany.com.br;
#         
#         # Let's Encrypt ACME Challenge (DEVE vir ANTES de location /)
#         location /.well-known/acme-challenge/ {
#             root /var/www/certbot;
#             allow all;
#         }
#         
#         # Let's Encrypt SSL
#         ssl_certificate /etc/letsencrypt/live/app.avelarcompany.com.br/fullchain.pem;
#         ssl_certificate_key /etc/letsencrypt/live/app.avelarcompany.com.br/privkey.pem;
#         
#         # Security headers
#         add_header X-Frame-Options "SAMEORIGIN" always;
#         add_header X-XSS-Protection "1; mode=block" always;
#         add_header X-Content-Type-Options "nosniff" always;
#         add_header Referrer-Policy "no-referrer-when-downgrade" always;
#         add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
#         
#         # =====================================
#         # STOCKTECH MODULE ROUTES
#         # =====================================
#         
#         # StockTech API routes  
#         location /stocktech/api/ {
#             limit_req zone=api burst=30 nodelay;
#             
#             # Remove /stocktech prefix and proxy to backend
#             rewrite ^/stocktech/api/(.*) /api/$1 break;
#             proxy_pass http://stocktech_backend;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#         }
#         
#         # StockTech uploads
#         location /stocktech/api/upload/ {
#             client_max_body_size 10M;
#             
#             rewrite ^/stocktech/api/(.*) /api/$1 break;
#             proxy_pass http://stocktech_backend;
#             proxy_http_version 1.1;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             
#             proxy_connect_timeout 120s;
#             proxy_send_timeout 120s;
#             proxy_read_timeout 120s;
#         }
#         
#         # StockTech frontend routes
#         location /stocktech/ {
#             # Remove /stocktech prefix for frontend
#             rewrite ^/stocktech/(.*) /$1 break;
#             rewrite ^/stocktech/?$ / break;
#             
#             proxy_pass http://stocktech_frontend;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#             
#             proxy_redirect off;
#             proxy_buffering off;
#         }
#         
#         # =====================================
#         # LUCRUM MODULE ROUTES (FUTURE)
#         # =====================================
#         
#         location /lucrum/ {
#             # Por enquanto redireciona para "em breve"
#             return 503;
#             add_header Content-Type "text/html; charset=utf-8";
#             return 503 '<!DOCTYPE html>
# <html lang="pt-BR">
# <head>
#     <meta charset="UTF-8">
#     <meta name="viewport" content="width=device-width, initial-scale=1.0">
#     <title>Lucrum - Em Desenvolvimento</title>
#     <style>
#         body { 
#             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
#             text-align: center; 
#             padding: 50px; 
#             background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%);
#             color: white;
#             min-height: 100vh;
#             display: flex;
#             align-items: center;
#             justify-content: center;
#             flex-direction: column;
#         }
#         .container { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 20px; backdrop-filter: blur(10px); }
#         h1 { font-size: 3em; margin: 0; }
#         p { font-size: 1.2em; opacity: 0.9; margin: 20px 0; }
#         a { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 15px 30px; border-radius: 10px; display: inline-block; margin-top: 20px; }
#     </style>
# </head>
# <body>
#     <div class="container">
#         <h1>üí∞ Lucrum</h1>
#         <p>Sistema Financeiro em desenvolvimento</p>
#         <p>Em breve dispon√≠vel!</p>
#         <a href="/">‚Üê Voltar ao Sistema Principal</a>
#     </div>
# </body>
# </html>';
#         }
#         
#         # =====================================
#         # AUTH ROUTES (Shared)
#         # =====================================
#         
#         location /api/auth/ {
#             limit_req zone=auth burst=10 nodelay;
#             
#             # Route auth to AvAdmin (centralized auth)
#             proxy_pass http://avadmin_backend;
#             proxy_http_version 1.1;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#         }
#         
#         # =====================================
#         # MAIN APP ROUTES
#         # =====================================
#         
#         # Health check
#         location /health {
#             access_log off;
#             return 200 "AvelarSys OK\n";
#             add_header Content-Type text/plain;
#         }
#         
#         # =====================================
#         # MAIN APP FRONTEND (Unified)
#         # =====================================
#         
#         # Root - Dashboard ou Login redirect
#         location = / {
#             proxy_pass http://app_portal;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#             proxy_redirect off;
#             proxy_buffering off;
#         }
#         
#         # Login page
#         location /login {
#             proxy_pass http://app_portal;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#             proxy_redirect off;
#             proxy_buffering off;
#         }
#         
#         # Dashboard (after login)
#         location /dashboard {
#             proxy_pass http://app_portal;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#             proxy_redirect off;
#             proxy_buffering off;
#         }
#         
#         # Fallback for other frontend routes
#         location / {
#             proxy_pass http://app_portal;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection 'upgrade';
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_cache_bypass $http_upgrade;
#             proxy_redirect off;
#             proxy_buffering off;
#         }
#     }

    # Include additional server configurations
    include /etc/nginx/conf.d/*.conf;


    # ========================================
    # DEFAULT SERVER (catch-all)
    # ========================================
    server {
        listen 80 default_server;
        listen 443 ssl;
        http2 on;
        server_name _;
        
        ssl_certificate /etc/ssl/certs/cloudflare.pem;
        ssl_certificate_key /etc/ssl/private/cloudflare.key;
        
        # Health check para Docker
        location /health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }
        
        # Fechar outras conex√µes
        location / {
            return 444;
        }
    }
}